{% extends "base_app.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Overview" }} - Locotion{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... (CSS from previous overview.html version - keep it or move to app_styles.css) ... */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background-color: #2c2830; padding: 20px; border-radius: 8px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            font-size: 0.9em; color: #BDB48A; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .summary-card .value { font-size: 1.8em; font-weight: 700; color: #EEEBDD; }
        .summary-card .value.positive { color: #81C784; }
        .summary-card .value.negative { color: #E57373; }

        .chart-container {
            background-color: #2c2830; padding: 20px; border-radius: 8px;
            margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-container h3 { text-align: center; color: #BDB48A; margin-bottom: 15px; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }

        .recent-activity-section h3 {
            color: #BDB48A; margin-bottom: 15px; font-size: 1.3em;
            border-bottom: 1px solid #4a464f; padding-bottom: 8px;
        }
        .activity-list { list-style: none; padding: 0; }
        .activity-item {
            background-color: #27232b; padding: 10px 15px; border-radius: 6px;
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9em;
        }
        .activity-item .date { color: #aaa; font-size: 0.85em; margin-right: 10px; white-space: nowrap;}
        .activity-item .description { flex-grow: 1; color: #ddd; }
        .activity-item .amount { font-weight: 600; }
        .activity-item .amount.positive { color: #81C784; }
        .activity-item .amount.negative { color: #E57373; }

        .quick-actions { margin-top: 30px; text-align: center; }
        .quick-actions .button-primary.small-button { /* Make sure .small-button exists or define it */
            margin: 0 5px; font-size:0.8em; padding: 8px 12px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="overview-page-container">
    <h1>{{ page_title|default:"Dashboard Overview" }}</h1>

    <section class="overview-grid">
        <div class="summary-card">
            <h3>Net Balance ({{overview_current_year|default_if_none:"Current Year"}})</h3> {# Assuming you pass overview_current_year #}
            <p class="value {% if current_year_net_balance >= 0 %}positive{% else %}negative{% endif %}">
                ${{ current_year_net_balance|floatformat:2|default:"0.00" }}
            </p>
        </div>
        <div class="summary-card">
            <h3>Total Documents</h3>
            <p class="value">{{ total_documents|default:"0" }}</p>
        </div>
        <div class="summary-card">
            <h3>Quick Actions</h3>
            <div style="margin-top:15px;">
                {# These links just navigate to the pages. To open modals, the target pages need JS to check URL anchors. #}
                <a href="{% url 'documents' %}" class="button-primary small-button">Add Document</a>
                <a href="{% url 'expenses' %}" class="button-primary small-button">Add Transaction</a>
            </div>
        </div>
    </section>

    <section class="overview-grid">
        <div class="chart-container">
            <h3>Year-over-Year Financials</h3>
            <div class="chart-wrapper">
                <canvas id="yoyChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h3>Expense Categories ({{overview_current_year|default_if_none:"Current Year"}} - Top 7)</h3> {# Assuming you pass overview_current_year #}
            <div class="chart-wrapper">
                <canvas id="categoryPieChart"></canvas>
            </div>
        </div>
    </section>

    <section class="recent-activity-section">
        <h3>Recent Financial Activity (Last 5)</h3>
        {% if recent_activity %}
            <ul class="activity-list">
                {% for item in recent_activity %}
                    <li class="activity-item">
                        <span class="date">{{ item.date|date:"M d, Y" }}</span>
                        <span class="description">
                            {{ item.type }}: {{ item.description|truncatechars:40 }}
                        </span>
                        <span class="amount {% if item.amount_type == 'GAIN' %}positive{% elif item.amount_type == 'EXPENSE' %}negative{% endif %}">
                            {% if item.amount_type == 'EXPENSE' %}-{% elif item.amount_type == 'GAIN' %}+{% endif %}${{ item.amount|floatformat:2 }}
                        </span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color:#ccc;">No recent financial activity.</p>
        {% endif %}
    </section>

    {# Data for charts passed from view, accessed by JavaScript #}
    {{ yoy_chart_data_json|json_script:"yoyChartData" }}
    {{ category_chart_data_json|json_script:"categoryPieChartData" }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const yoyCtx = document.getElementById('yoyChart');
    const categoryCtx = document.getElementById('categoryPieChart');

    if (yoyCtx) {
        try { // Add try-catch for parsing robustness
            const yoyRawData = JSON.parse(document.getElementById('yoyChartData').textContent);
            if (yoyRawData && yoyRawData.labels && yoyRawData.gains && yoyRawData.expenses) {
                new Chart(yoyCtx, {
                    type: 'bar',
                    data: {
                        labels: yoyRawData.labels,
                        datasets: [
                            { label: 'Total Gains', data: yoyRawData.gains, backgroundColor: 'rgba(75, 192, 192, 0.6)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 },
                            { label: 'Total Expenses', data: yoyRawData.expenses, backgroundColor: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#EEEBDD' }, grid: { color: 'rgba(238,235,221,0.2)'} }, x: { ticks: { color: '#EEEBDD' }, grid: { color: 'rgba(238,235,221,0.2)'} } }, plugins: { legend: { labels: { color: '#EEEBDD' } } } }
                });
            } else { console.error("Year-over-year chart data is missing or malformed:", yoyRawData); }
        } catch (e) { console.error("Error parsing YoY chart data:", e); }
    }

    if (categoryCtx) {
        try { // Add try-catch for parsing
            const categoryRawData = JSON.parse(document.getElementById('categoryPieChartData').textContent);
            if (categoryRawData && categoryRawData.labels && categoryRawData.data) {
                new Chart(categoryCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryRawData.labels,
                        datasets: [{
                            label: 'Expenses by Category', data: categoryRawData.data,
                            backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(199, 199, 199, 0.7)'],
                            borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(199, 199, 199, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#EEEBDD' } } } }
                });
            } else { console.error("Category chart data is missing or malformed:", categoryRawData); }
        } catch (e) { console.error("Error parsing category chart data:", e); }
    }
});
</script>
{% endblock %}